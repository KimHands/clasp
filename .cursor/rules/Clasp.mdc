---
description: 
alwaysApply: true
---

# Cursor Rules — 파일 정리 및 시각화 도구

You are an expert developer for a desktop file organizer and visualization app called Clasp.

---

## Project Overview

- Electron + React (Frontend) + Python FastAPI (Backend) desktop application
- Classifies local files using metadata rules, embedding similarity, and optional cloud LLM
- Visualizes classification results as a graph using Cytoscape.js
- Fully local processing for privacy — no file content sent to external servers by default
- Target users: 대학생 (과제/자료 정리), 직장인 (업무 문서 정리), 개발자

---

## Tech Stack

### Frontend
- Electron + electron-builder (app packaging)
- React + Vite (UI framework)
- Zustand (state management)
- shadcn/ui + Tailwind CSS (UI components)
- Cytoscape.js + fcose + compound (graph visualization)
- SSE (real-time scan progress from FastAPI)

### Backend
- Python FastAPI (async backend, runs as PyInstaller bundle on localhost:8000)
- SQLite + SQLAlchemy ORM (local database)
- PyMuPDF (PDF text extraction, page-level access)
- python-docx (DOCX paragraph-level extraction)
- sentence-transformers: paraphrase-multilingual-MiniLM-L12-v2 (Tier 2 embedding)
- scikit-learn cosine_similarity (similarity calculation)
- OpenAI API (optional Tier 3 LLM, only when user provides API key)
- sse-starlette (SSE streaming to frontend)

---

## Project Structure

```
file-organizer/
 ├── frontend/
 │    ├── src/
 │    │    ├── components/   # shared UI components
 │    │    ├── pages/        # Home, Scan, Result, RuleManager, Settings
 │    │    ├── store/        # Zustand stores
 │    │    ├── api/          # FastAPI call functions (centralized)
 │    │    └── graph/        # Cytoscape.js related
 │    └── electron/
 │         ├── main.js       # Electron main process
 │         └── preload.js
 │
 └── backend/
      ├── routers/           # scan.py, classify.py, files.py, rules.py
      ├── services/          # scan_service, classify_service, cover_service, action_service
      ├── engines/           # tier1_rule, tier2_embedding, tier3_llm, pipeline
      ├── models/            # schema.py (SQLAlchemy models)
      └── utils/             # text_extractor.py, cover_detector.py
```

---

## Database Schema

```sql
files (
  id, path, filename, extension,
  created_at, modified_at, size, extracted_text_summary
)

classifications (
  file_id, category, tag,
  tier_used,          -- 사용된 분류 Tier (1/2/3)
  confidence_score,   -- 신뢰도 0.0 ~ 1.0
  is_manual           -- 수동 수정 여부
)

cover_pages (
  file_id, cover_text,
  embedding,          -- JSON 직렬화 벡터
  detected_at
)

cover_similarity_groups (
  group_id, file_id,
  similarity_score, auto_tag
)

action_logs (
  id, action_type,
  source_path, destination_path,
  executed_at, is_undone
)
```

---

## Classification Engine (Tier System)

```
Tier 1 (항상 동작)
 └── 규칙 기반: 확장자 매핑 딕셔너리 + 파일명 날짜 정규식
      → 신뢰도 높음: Tier 2 스킵, 결과 저장
      → 신뢰도 낮음: Tier 2 호출

Tier 2 (텍스트 추출 가능 파일)
 └── sentence-transformers 임베딩
      사전 정의 카테고리와 코사인 유사도 계산
      → 신뢰도 높음: 결과 저장
      → 신뢰도 낮음 + API 키 있음: Tier 3 호출
      → 신뢰도 낮음 + API 키 없음: 미분류 처리

Tier 3 (선택적, API 키 필요)
 └── OpenAI API 분류 → 결과 저장

미분류: confidence_score < 0.31 → 격리, 파일 이동 제외
```

---

## Text Extraction Strategy

```
PDF
 ├── 3페이지 이상: 1~2페이지(표지/목차) 스킵
 └── 4구간 샘플링: 30% / 45% / 65% / 85% 지점 각 300자 (총 1200자)

DOCX
 └── python-docx 단락 단위 추출

표지 탐지 기준
 ├── 페이지 텍스트 300자 미만
 └── 날짜(\d{4}년), 학번, 과목명 패턴 매칭

표지 유사도
 └── 표지 임베딩 코사인 유사도 ≥ 0.75 → 같은 태그 그룹
```

---

## API Endpoints

```
POST   /scan/start          스캔 시작 (BackgroundTask)
GET    /scan/progress       SSE 진행 상황 스트림
GET    /files               분류 결과 목록 조회
PATCH  /files/{id}          수동 분류 수정
GET    /files/{id}/similar  표지 유사 파일 목록
GET    /rules               규칙 목록 조회
POST   /rules               규칙 추가
PATCH  /rules/{id}          규칙 수정
DELETE /rules/{id}          규칙 삭제
POST   /apply               정리 적용 실행
POST   /undo                되돌리기
```

---

## Coding Rules

1. **FastAPI**: 모든 라우터와 서비스는 async 함수로 작성
2. **SQLAlchemy**: ORM 사용, raw SQL 문자열 사용 금지
3. **분류 결과**: 반드시 `tier_used`와 `confidence_score` 포함
4. **API 호출**: 프론트엔드의 모든 API 호출은 `src/api/`에 중앙화
5. **Zustand**: 컴포넌트에서 직접 API 호출 금지, store를 단일 진실 공급원으로 사용
6. **파일 수정 시**: 변경된 부분만 아닌 전체 파일 내용 출력
7. **주석**: 비즈니스 로직은 한국어, 기술 구현은 영어
8. **파일 구조 준수**: 정의된 구조 외 새 파일 생성 금지
9. **미분류 처리**: confidence < 0.31 파일은 반드시 격리 처리
10. **표지 임베딩**: cover_pages 테이블에 JSON 직렬화하여 저장
